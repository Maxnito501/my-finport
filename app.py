# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime

# --- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(
    page_title="FinPort - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏õ‡∏£",
    page_icon=":bank:",
    layout="wide"
)

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ---
def calculate_wealth(assets_df, liabs_df):
    t_a = assets_df["‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤"].sum() if not assets_df.empty else 0
    t_l = liabs_df["‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤"].sum() if not liabs_df.empty else 0
    return t_a, t_l, t_a - t_l

# --- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ---
ASSET_CATEGORIES = [
    "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å", 
    "‡∏Å‡∏ö‡∏Ç./‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ø",
    "‡∏´‡∏∏‡πâ‡∏ô‡∏Å‡∏π‡πâ/‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå", 
    "‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ (RMF/SSF)",
    "‡∏´‡∏∏‡πâ‡∏ô/‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏î‡∏±‡∏ä‡∏ô‡∏µ", 
    "‡∏´‡∏∏‡πâ‡∏ô‡∏õ‡∏±‡∏ô‡∏ú‡∏•", 
    "‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï/‡∏´‡∏∏‡πâ‡∏ô‡∏ã‡∏¥‡πà‡∏á",
    "‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥/‡∏Ñ‡∏£‡∏¥‡∏õ‡πÇ‡∏ï)"
]
LIAB_CATEGORIES = ["‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô", "‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß"]

# --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Session State) ---
if 'assets' not in st.session_state:
    st.session_state.assets = pd.DataFrame([
        {"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤": 50000, "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà": "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å"},
        {"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": "‡∏Å‡∏ö‡∏Ç. (‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏∞‡∏™‡∏°+‡∏™‡∏°‡∏ó‡∏ö)", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤": 350000, "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà": "‡∏Å‡∏ö‡∏Ç./‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ø"},
        {"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": "‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤": 500000, "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà": "‡∏´‡∏∏‡πâ‡∏ô‡∏Å‡∏π‡πâ/‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå"},
        {"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": "RMF ‡∏´‡∏∏‡πâ‡∏ô‡πÇ‡∏•‡∏Å", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤": 150000, "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà": "‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ (RMF/SSF)"},
        {"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": "‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏î‡∏±‡∏ä‡∏ô‡∏µ SET50", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤": 120000, "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà": "‡∏´‡∏∏‡πâ‡∏ô/‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏î‡∏±‡∏ä‡∏ô‡∏µ"},
        {"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": "‡∏´‡∏∏‡πâ‡∏ô‡∏õ‡∏±‡∏ô‡∏ú‡∏• (DCA)", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤": 250000, "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà": "‡∏´‡∏∏‡πâ‡∏ô‡∏õ‡∏±‡∏ô‡∏ú‡∏•"},
        {"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": "‡∏´‡∏∏‡πâ‡∏ô‡∏ã‡∏¥‡πà‡∏á (‡πÄ‡∏Å‡πá‡∏á‡∏Å‡∏≥‡πÑ‡∏£)", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤": 80000, "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà": "‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï/‡∏´‡∏∏‡πâ‡∏ô‡∏ã‡∏¥‡πà‡∏á"}
    ])

if 'liabilities' not in st.session_state:
    st.session_state.liabilities = pd.DataFrame([
        {"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": "‡∏´‡∏ô‡∏µ‡πâ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤": 5000, "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà": "‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô"}
    ])

# --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å ---
st.title("üèØ FinPort: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå")
st.write(f"‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á: {datetime.now().strftime('%d/%m/%Y')}")

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
total_a, total_l, net_w = calculate_wealth(st.session_state.assets, st.session_state.liabilities)

# ‡πÅ‡∏ñ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Metric Cards)
c1, c2, c3 = st.columns(3)
with c1:
    st.metric("‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏£‡∏ß‡∏° (Assets)", f"{total_a:,.0f} ‡∏ø")
with c2:
    st.metric("‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏£‡∏ß‡∏° (Liabilities)", f"{total_l:,.0f} ‡∏ø", delta_color="inverse")
with c3:
    st.metric("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Worth)", f"{net_w:,.0f} ‡∏ø")

st.divider()

# ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤
left_col, right_col = st.columns([2, 1])

with left_col:
    st.subheader("üìä ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó")
    if not st.session_state.assets.empty and st.session_state.assets["‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤"].sum() > 0:
        fig = px.pie(
            st.session_state.assets, 
            values='‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤', 
            names='‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 
            hole=0.4,
            color_discrete_sequence=px.colors.qualitative.Pastel
        )
        fig.update_traces(textposition='inside', textinfo='percent+label')
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.info("üí° ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô")

with right_col:
    st.subheader("‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà")
    with st.form("add_item_form", clear_on_submit=True):
        target = st.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå", "‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô"], horizontal=True)
        name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        val = st.number_input("‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)", min_value=0, step=1000)
        
        if target == "‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå":
            cat = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå", ASSET_CATEGORIES)
        else:
            cat = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô", LIAB_CATEGORIES)
            
        if st.form_submit_button("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏≠‡∏£‡πå‡∏ï"):
            if name:
                new_row = pd.DataFrame([{"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": name, "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤": val, "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà": cat}])
                if target == "‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå":
                    st.session_state.assets = pd.concat([st.session_state.assets, new_row], ignore_index=True)
                else:
                    st.session_state.liabilities = pd.concat([st.session_state.liabilities, new_row], ignore_index=True)
                st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")
                st.rerun()
            else:
                st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Editor Section) ---
st.subheader("üõ† ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡∏≠‡∏£‡πå‡∏ï")
st.caption("‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ")

tab1, tab2 = st.tabs(["üí∞ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå", "üí≥ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô"])

with tab1:
    # ‡πÉ‡∏ä‡πâ Data Editor ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
    edited_assets = st.data_editor(
        st.session_state.assets,
        column_config={
            "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà": st.column_config.SelectboxColumn(
                "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà",
                options=ASSET_CATEGORIES,
                required=True,
            ),
            "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤": st.column_config.NumberColumn(
                "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ø)",
                format="%d",
                min_value=0,
            )
        },
        num_rows="dynamic", # ‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÑ‡∏î‡πâ
        use_container_width=True,
        key="asset_editor"
    )
    # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Session State ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
    if not edited_assets.equals(st.session_state.assets):
        st.session_state.assets = edited_assets
        st.rerun()

with tab2:
    edited_liabs = st.data_editor(
        st.session_state.liabilities,
        column_config={
            "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà": st.column_config.SelectboxColumn(
                "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà",
                options=LIAB_CATEGORIES,
                required=True,
            ),
            "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤": st.column_config.NumberColumn(
                "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ø)",
                format="%d",
                min_value=0,
            )
        },
        num_rows="dynamic",
        use_container_width=True,
        key="liab_editor"
    )
    if not edited_liabs.equals(st.session_state.liabilities):
        st.session_state.liabilities = edited_liabs
        st.rerun()

# --- ‡πÅ‡∏ñ‡∏ö Sidebar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ---
st.sidebar.title("üìà ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á")

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
high_risk_cats = ["‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï/‡∏´‡∏∏‡πâ‡∏ô‡∏ã‡∏¥‡πà‡∏á", "‡∏´‡∏∏‡πâ‡∏ô/‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏î‡∏±‡∏ä‡∏ô‡∏µ", "‡∏´‡∏∏‡πâ‡∏ô‡∏õ‡∏±‡∏ô‡∏ú‡∏•", "‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥/‡∏Ñ‡∏£‡∏¥‡∏õ‡πÇ‡∏ï)"]
low_risk_cats = ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å", "‡∏Å‡∏ö‡∏Ç./‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ø", "‡∏´‡∏∏‡πâ‡∏ô‡∏Å‡∏π‡πâ/‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå", "‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ (RMF/SSF)"]

risk_high = st.session_state.assets[st.session_state.assets['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'].isin(high_risk_cats)]['‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤'].sum() if not st.session_state.assets.empty else 0
risk_low = st.session_state.assets[st.session_state.assets['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'].isin(low_risk_cats)]['‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤'].sum() if not st.session_state.assets.empty else 0

total_val = risk_high + risk_low
if total_val > 0:
    st.sidebar.write(f"‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (High Risk): **{risk_high:,.0f} ‡∏ø**")
    st.sidebar.write(f"‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á (Low Risk): **{risk_low:,.0f} ‡∏ø**")
    
    high_pct = (risk_high / total_val) * 100
    st.sidebar.progress(risk_high / total_val)
    st.sidebar.caption(f"‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á {high_pct:.1f}% / ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á {100-high_pct:.1f}%")
    
    if high_pct > 70:
        st.sidebar.warning("‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å!")
    elif high_pct < 30:
        st.sidebar.info("‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å")
    else:
        st.sidebar.success("‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏î‡∏µ")
else:
    st.sidebar.write("‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á...")

st.sidebar.divider()
st.sidebar.caption("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á")
